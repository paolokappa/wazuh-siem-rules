  <agent_config os="Windows">
    <!-- ============================================ -->
    <!-- WAZUH ENTERPRISE WINDOWS SERVER CONFIG 2025  -->
    <!-- Version: 4.12.0 - Production Ready           -->
    <!-- Supports: DC, Exchange, SQL, IIS, File/Print -->
    <!-- Hyper-V, RDS, WSUS, Storage Spaces          -->
    <!-- ============================================ -->
    <!-- Client Buffer - Enterprise Grade -->
    <client_buffer>
      <disabled>no</disabled>
      <queue_size>100000</queue_size>
      <events_per_second>1000</events_per_second>
    </client_buffer>
    <!-- Security Configuration Assessment (Replaces deprecated rootcheck) -->
    <sca>
      <enabled>yes</enabled>
      <interval>12h</interval>
      <scan_on_start>yes</scan_on_start>
      <skip_nfs>yes</skip_nfs>
      <policies>
        <policy>ruleset/sca/cis_win2019.yml</policy>
        <policy>ruleset/sca/cis_win2022.yml</policy>
        <policy>ruleset/sca/win_audit_rcl.yml</policy>
      </policies>
    </sca>
    <!-- Agent Upgrade - Corrected -->
    <agent-upgrade>
      <enabled>yes</enabled>
      <notification_wait_start>60</notification_wait_start>
      <notification_wait_factor>2</notification_wait_factor>
      <notification_wait_max>7200</notification_wait_max>
      <ca_verification>
        <enabled>yes</enabled>
        <ca_store>etc/wpk_root.pem</ca_store>
      </ca_verification>
    </agent-upgrade>
    <!-- Vulnerability Detector -->
    <vulnerability-detector>
      <enabled>yes</enabled>
      <interval>5m</interval>
      <min_full_scan_interval>6h</min_full_scan_interval>
      <run_on_start>yes</run_on_start>
    </vulnerability-detector>
    <!-- Syscollector - Enhanced for Servers -->
    <wodle name="syscollector">
      <disabled>no</disabled>
      <interval>6h</interval>
      <scan_on_start>yes</scan_on_start>
      <hardware>yes</hardware>
      <os>yes</os>
      <network>yes</network>
      <packages>yes</packages>
      <ports all="yes">yes</ports>
      <processes>yes</processes>
      <hotfixes>yes</hotfixes>
      <synchronization>
        <max_eps>10</max_eps>
      </synchronization>
    </wodle>
    <!-- ============================================ -->
    <!-- SYSMON INTEGRATION - ENTERPRISE              -->
    <!-- ============================================ -->
    <localfile>
      <location>Microsoft-Windows-Sysmon/Operational</location>
      <log_format>eventchannel</log_format>
    </localfile>
    <!-- ============================================ -->
    <!-- WINDOWS SECURITY EVENTS - ENTERPRISE         -->
    <!-- ============================================ -->
    <!-- Security Events -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Security</location>
    </localfile>
    <!-- System Events -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>System</location>
    </localfile>
    <!-- Application Events -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Application</location>
    </localfile>
    <!-- PowerShell -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-PowerShell/Operational</location>
    </localfile>
    <!-- Windows Defender -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-Windows Defender/Operational</location>
    </localfile>
    <!-- WMI Activity -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-WMI-Activity/Operational</location>
    </localfile>
    <!-- Task Scheduler -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-TaskScheduler/Operational</location>
    </localfile>
    <!-- Windows Firewall -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-Windows Firewall With Advanced Security/Firewall</location>
    </localfile>
    <!-- Code Integrity -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-CodeIntegrity/Operational</location>
    </localfile>
    <!-- APPLOCKER -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-AppLocker/EXE and DLL</location>
    </localfile>
    <!-- ============================================ -->
    <!-- ACTIVE DIRECTORY / DOMAIN CONTROLLER         -->
    <!-- ============================================ -->
    <!-- Directory Service -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Directory Service</location>
    </localfile>
    <!-- DNS Server -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>DNS Server</location>
    </localfile>
    <!-- DFS Replication -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>DFS Replication</location>
    </localfile>
    <!-- Group Policy -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-GroupPolicy/Operational</location>
    </localfile>
    <!-- ============================================ -->
    <!-- IIS / WEB SERVER                             -->
    <!-- ============================================ -->
    <!-- IIS Configuration -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-IIS-Configuration/Operational</location>
    </localfile>
    <!-- IIS Logs -->
    <localfile>
      <log_format>iis</log_format>
      <location>C:\inetpub\logs\LogFiles\W3SVC*\*.log</location>
    </localfile>
    <!-- ============================================ -->
    <!-- PRINT SERVER                                 -->
    <!-- ============================================ -->
    <!-- Print Service Operational -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-PrintService/Operational</location>
    </localfile>
    <!-- Print Service Admin -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-PrintService/Admin</location>
    </localfile>
    <!-- ============================================ -->
    <!-- FILE SERVER / SMB                            -->
    <!-- ============================================ -->
    <!-- SMB Server -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-SMBServer/Operational</location>
    </localfile>
    <!-- SMB Client -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-SMBClient/Operational</location>
    </localfile>
    <!-- Storage Spaces -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-StorageSpaces-Driver/Operational</location>
    </localfile>
    <!-- ============================================ -->
    <!-- HYPER-V VIRTUALIZATION - CORRECTED           -->
    <!-- ============================================ -->
    <!-- Hyper-V VMMS -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-Hyper-V-VMMS/Operational</location>
    </localfile>
    <!-- Hyper-V Worker -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-Hyper-V-Worker/Operational</location>
    </localfile>
    <!-- Hyper-V Hypervisor -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-Hyper-V-Hypervisor/Operational</location>
    </localfile>
    <!-- Hyper-V Compute -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-Hyper-V-Compute/Operational</location>
    </localfile>
    <!-- ============================================ -->
    <!-- TERMINAL SERVICES / RDS                      -->
    <!-- ============================================ -->
    <!-- Terminal Services Local Session Manager -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-TerminalServices-LocalSessionManager/Operational</location>
    </localfile>
    <!-- Terminal Services Remote Connection Manager -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational</location>
    </localfile>
    <!-- Terminal Services Gateway -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-TerminalServices-Gateway/Operational</location>
    </localfile>
    <!-- ============================================ -->
    <!-- DHCP SERVER                                  -->
    <!-- ============================================ -->
    <!-- DHCP Server Admin Events -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>DhcpAdminEvents</location>
    </localfile>
    <!-- DHCP Server Operational -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-Dhcp-Server/Operational</location>
    </localfile>
    <!-- ============================================ -->
    <!-- CERTIFICATE SERVICES                         -->
    <!-- ============================================ -->
    <!-- Certificate Authority -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-CertificationAuthority/Operational</location>
    </localfile>
    <!-- ============================================ -->
    <!-- BACKUP SERVICES                              -->
    <!-- ============================================ -->
    <!-- Windows Server Backup -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-Backup</location>
    </localfile>
    <!-- ============================================ -->
    <!-- FAILOVER CLUSTERING                          -->
    <!-- ============================================ -->
    <!-- Failover Clustering -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-FailoverClustering/Operational</location>
    </localfile>
    <!-- ============================================ -->
    <!-- FILE INTEGRITY MONITORING - CORRECTED        -->
    <!-- ============================================ -->
    <syscheck>
      <frequency>21600</frequency>
      <scan_on_start>no</scan_on_start>
      <file_limit>
        <enabled>yes</enabled>
        <entries>200000</entries>
      </file_limit>
      <synchronization>
        <enabled>yes</enabled>
        <interval>5m</interval>
        <max_interval>1h</max_interval>
        <response_timeout>30</response_timeout>
        <max_eps>100</max_eps>
      </synchronization>
      <!-- Critical System Directories -->
      <directories check_all="yes" realtime="yes" report_changes="yes">C:\Windows\System32\drivers\etc</directories>
      <directories check_all="yes" realtime="yes" check_md5sum="yes" check_sha256sum="yes">C:\Windows\System32\drivers</directories>
      <directories check_all="yes" recursion_level="1">C:\Windows\System32\Tasks</directories>
      <directories check_all="yes" realtime="yes">C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup</directories>
      <directories check_all="yes" restrict=".exe$|.dll$|.sys$">C:\Windows\System32</directories>
      <directories check_all="yes" restrict=".exe$|.dll$">C:\Windows\SysWOW64</directories>
      <!-- Active Directory -->
      <directories check_all="yes" realtime="yes">C:\Windows\NTDS</directories>
      <directories check_all="yes" realtime="yes">C:\Windows\SYSVOL</directories>
      <!-- IIS / Web Server -->
      <directories check_all="yes" realtime="yes" report_changes="yes" recursion_level="3">C:\inetpub\wwwroot</directories>
      <directories check_all="yes" realtime="yes" report_changes="yes">C:\Windows\System32\inetsrv\config</directories>
      <!-- Print Server -->
      <directories check_all="yes">C:\Windows\System32\spool\drivers</directories>
      <!-- Certificate Services -->
      <directories check_all="yes" realtime="yes">C:\Windows\System32\CertSrv</directories>
      <!-- General Applications -->
      <directories check_all="yes" recursion_level="1" restrict=".exe$|.dll$">C:\Program Files</directories>
      <directories check_all="yes" recursion_level="1" restrict=".exe$|.dll$">C:\Program Files (x86)</directories>
      <!-- Critical Registry Keys -->
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Active Setup\Installed Components</windows_registry>
      <!-- Exclusions - Optimized -->
      <ignore>C:\Windows\Temp</ignore>
      <ignore>C:\Windows\SoftwareDistribution</ignore>
      <ignore>C:\Windows\WinSxS</ignore>
      <ignore>C:\Windows\Installer\$PatchCache$</ignore>
      <ignore>C:\Windows\Logs</ignore>
      <ignore>C:\Windows\Prefetch</ignore>
      <ignore>C:\Windows\System32\LogFiles</ignore>
      <ignore>C:\Windows\System32\winevt\Logs</ignore>
      <ignore>C:\Windows\System32\spool\PRINTERS</ignore>
      <ignore>C:\ProgramData\Microsoft\Windows\WER</ignore>
      <ignore>C:\ProgramData\Microsoft\Windows Defender</ignore>
      <ignore>C:\$Recycle.Bin</ignore>
      <ignore>C:\System Volume Information</ignore>
      <ignore>C:\pagefile.sys</ignore>
      <ignore>C:\hiberfil.sys</ignore>
      <ignore>C:\swapfile.sys</ignore>
      <!-- IIS Exclusions -->
      <ignore>C:\inetpub\logs</ignore>
      <ignore>C:\inetpub\temp</ignore>
      <!-- SQL Server Exclusions -->
      <ignore type="sregex">\.ldf$|\.mdf$|\.ndf$</ignore>
      <!-- Hyper-V Exclusions -->
      <ignore type="sregex">\.vhd$|\.vhdx$|\.avhd$|\.avhdx$</ignore>
      <!-- File Type Exclusions -->
      <ignore type="sregex">\.log$|\.tmp$|\.temp$|\.bak$|\.old$</ignore>
      <!-- Alert on new files -->
      <alert_new_files>yes</alert_new_files>
    </syscheck>
    <!-- ============================================ -->
    <!-- OSQUERY INTEGRATION                          -->
    <!-- ============================================ -->
    <wodle name="osquery">
      <disabled>yes</disabled>
      <run_daemon>yes</run_daemon>
      <bin_path>C:\Program Files\osquery\osqueryd\osqueryd.exe</bin_path>
      <log_path>C:\Program Files\osquery\log\osqueryd.results.log</log_path>
      <config_path>C:\Program Files\osquery\osquery.conf</config_path>
      <add_labels>yes</add_labels>
    </wodle>
    <!-- ============================================ -->
    <!-- CIS-CAT SCAN                                 -->
    <!-- ============================================ -->
    <wodle name="cis-cat">
      <disabled>yes</disabled>
      <timeout>1800</timeout>
      <interval>1d</interval>
      <scan-on-start>yes</scan-on-start>
      <java_path>C:\Program Files\Java\jre\bin\java.exe</java_path>
      <ciscat_path>C:\cis-cat</ciscat_path>
    </wodle>
    <!-- ============================================ -->
    <!-- COMMAND MONITORING - ENTERPRISE              -->
    <!-- ============================================ -->
    <!-- Check Server Roles and Features -->
    <wodle name="command">
      <disabled>no</disabled>
      <tag>server-roles-features</tag>
      <command>Powershell.exe -ExecutionPolicy Bypass -Command "Get-WindowsFeature | Where-Object {$_.Installed -eq $true} | Select-Object Name, DisplayName | ConvertTo-Json -Compress"</command>
      <interval>1d</interval>
      <run_on_start>yes</run_on_start>
      <timeout>60</timeout>
    </wodle>
    <!-- Monitor Critical Services -->
    <wodle name="command">
      <disabled>no</disabled>
      <tag>critical-services-status</tag>
      <command>Powershell.exe -ExecutionPolicy Bypass -Command "$services = @('W3SVC','MSSQLSERVER','MSExchangeServiceHost','Spooler','DNS','NTDS','CertSvc','vmms','TermService','WinDefend'); Get-Service -Name $services -ErrorAction SilentlyContinue | Select-Object Name, DisplayName, Status, StartType | ConvertTo-Json -Compress"</command>
      <interval>5m</interval>
      <run_on_start>yes</run_on_start>
      <timeout>30</timeout>
    </wodle>
    <!-- Monitor Disk Space -->
    <wodle name="command">
      <disabled>no</disabled>
      <tag>disk-space-monitor</tag>
      <command>Powershell.exe -ExecutionPolicy Bypass -Command "Get-CimInstance Win32_LogicalDisk | Where-Object {$_.DriveType -eq 3} | Select-Object DeviceID, @{N='FreeGB';E={[Math]::Round($_.FreeSpace/1GB,2)}}, @{N='SizeGB';E={[Math]::Round($_.Size/1GB,2)}}, @{N='UsedPercent';E={[Math]::Round((($_.Size-$_.FreeSpace)/$_.Size)*100,2)}} | ConvertTo-Json -Compress"</command>
      <interval>30m</interval>
      <run_on_start>yes</run_on_start>
      <timeout>30</timeout>
    </wodle>
    <!-- Check Certificate Expiration -->
    <wodle name="command">
      <disabled>no</disabled>
      <tag>certificate-expiration</tag>
      <command>Powershell.exe -ExecutionPolicy Bypass -Command "Get-ChildItem Cert:\LocalMachine\My | Where-Object {$_.NotAfter -lt (Get-Date).AddDays(30)} | Select-Object Subject, Thumbprint, @{N='ExpiresIn';E={($_.NotAfter - (Get-Date)).Days}} | ConvertTo-Json -Compress"</command>
      <interval>1d</interval>
      <run_on_start>yes</run_on_start>
      <timeout>30</timeout>
    </wodle>
    <!-- ============================================ -->
    <!-- ACTIVE RESPONSE CONFIGURATION                -->
    <!-- ============================================ -->
    <active-response>
      <disabled>no</disabled>
      <ca_store>C:\Program Files (x86)\ossec-agent\wpk_root.pem</ca_store>
      <repeated_offenders>60,120,240,480,960</repeated_offenders>
    </active-response>
    <!-- ============================================ -->
    <!-- LABELS FOR CATEGORIZATION                    -->
    <!-- ============================================ -->
    <labels>
      <label key="environment">production</label>
      <label key="os">windows_server</label>
      <label key="os_version">2019_2022_2025</label>
      <label key="role">enterprise_server</label>
      <label key="services">multi_role</label>
      <label key="criticality">critical</label>
    </labels>
  </agent_config>

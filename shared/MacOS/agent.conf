  <agent_config os="darwin">
    <!-- Security Configuration Assessment (SCA) - CORRETTA -->
    <sca>
      <enabled>yes</enabled>
      <scan_on_start>yes</scan_on_start>
      <interval>12h</interval>
      <!-- Best practice: 12h invece di 8h per produzione -->
      <skip_nfs>yes</skip_nfs>
      <!-- Aggiunta policy CIS specifica per macOS -->
      <policies>
        <policy>ruleset/sca/cis_apple_macOS_14.x.yml</policy>
        <!-- Adatta alla versione macOS in uso -->
      </policies>
    </sca>
    <!-- Agent Upgrade - PERCORSO CORRETTO -->
    <agent-upgrade>
      <enabled>yes</enabled>
      <notification_wait_start>60s</notification_wait_start>
      <notification_wait_factor>2</notification_wait_factor>
      <notification_wait_max>2h</notification_wait_max>
      <ca_verification>
        <enabled>yes</enabled>
        <ca_store>/Library/Ossec/etc/wpk_root.pem</ca_store>
        <!-- Percorso completo corretto -->
      </ca_verification>
    </agent-upgrade>
    <!-- Rootcheck - FREQUENZA CORRETTA E CONFIGURAZIONE COMPLETA -->
    <rootcheck>
      <disabled>no</disabled>
      <frequency>43200</frequency>
      <!-- CRITICO: 12 ore (43200s) invece di 360s (6 minuti) -->
      <check_unixaudit>yes</check_unixaudit>
      <!-- Aggiunto per macOS -->
      <check_files>yes</check_files>
      <check_trojans>yes</check_trojans>
      <check_dev>yes</check_dev>
      <!-- Cambiato da no a yes -->
      <check_sys>yes</check_sys>
      <check_pids>yes</check_pids>
      <!-- Cambiato da no a yes -->
      <check_ports>yes</check_ports>
      <!-- Cambiato da no a yes -->
      <check_if>yes</check_if>
      <!-- Cambiato da no a yes -->
      <rootkit_files>etc/shared/rootkit_files.txt</rootkit_files>
      <rootkit_trojans>etc/shared/rootkit_trojans.txt</rootkit_trojans>
      <skip_nfs>yes</skip_nfs>
    </rootcheck>
    <!-- Monitoraggio log macOS con Unified Logging System - CONFIGURAZIONE MODERNA -->
    <localfile>
      <location>macos</location>
      <!-- Usa il formato nativo macOS -->
      <log_format>macos</log_format>
      <query type="trace,log,activity" level="info">
      (process == "sudo") OR 
      (process == "sshd") OR 
      (process == "tccd" AND message CONTAINS "Update Access Record") OR 
      (process == "securityd" AND eventMessage CONTAINS "Session") OR
      (process == "screensharingd" AND message CONTAINS "Authentication") OR
      (process == "loginwindow") OR
      (process == "authd") OR
      (process == "kernel" AND eventMessage CONTAINS "AMFI")
    </query>
    </localfile>
    <!-- File Integrity Monitoring (FIM) - CONFIGURAZIONE OTTIMIZZATA -->
    <syscheck>
      <disabled>no</disabled>
      <frequency>21600</frequency>
      <!-- 6 ore per sistemi critici -->
      <scan_on_start>yes</scan_on_start>
      <process_priority>5</process_priority>
      <!-- Ottimizzazione performance -->
      <database>memory</database>
      <!-- Database in memoria per performance migliori -->
      <max_eps>100</max_eps>
      <!-- Limite eventi per secondo -->
      <synchronization>
        <enabled>yes</enabled>
        <interval>5m</interval>
        <max_interval>1h</max_interval>
      </synchronization>
      <!-- File limit configuration -->
      <file_limit>
        <enabled>yes</enabled>
        <entries>1000000</entries>
        <!-- Aumentato per macOS -->
      </file_limit>
      <!-- Directory critiche di sistema macOS -->
      <directories check_all="yes" check_sum="yes" realtime="no">/System/Library/LaunchDaemons</directories>
      <directories check_all="yes" check_sum="yes" realtime="no">/Library/LaunchDaemons</directories>
      <directories check_all="yes" check_sum="yes" realtime="no">/Library/LaunchAgents</directories>
      <directories check_all="yes" check_sum="yes" realtime="no">/System/Library/LaunchAgents</directories>
      <!-- Directory applicazioni -->
      <directories check_all="yes" check_sum="yes">/Applications</directories>
      <directories check_all="yes" check_sum="yes">/Applications/Utilities</directories>
      <!-- File di configurazione sistema -->
      <directories check_all="yes" report_changes="yes">/etc</directories>
      <directories check_all="yes" check_sum="yes">/private/etc</directories>
      <!-- Binary directories -->
      <directories check_all="yes" check_sum="yes">/bin</directories>
      <directories check_all="yes" check_sum="yes">/sbin</directories>
      <directories check_all="yes" check_sum="yes">/usr/bin</directories>
      <directories check_all="yes" check_sum="yes">/usr/sbin</directories>
      <directories check_all="yes" check_sum="yes">/usr/local/bin</directories>
      <directories check_all="yes" check_sum="yes">/usr/local/sbin</directories>
      <!-- Homebrew directories (Apple Silicon e Intel) - IMPORTANTE PER SICUREZZA -->
      <directories check_all="yes" tags="homebrew-risk">/opt/homebrew/bin</directories>
      <directories check_all="yes" tags="homebrew-risk">/opt/homebrew/sbin</directories>
      <directories check_all="yes" tags="homebrew-risk">/usr/local/Homebrew</directories>
      <!-- User LaunchAgents (tutti gli utenti) -->
      <directories check_all="yes" check_sum="yes">/Users/*/Library/LaunchAgents</directories>
      <!-- Framework e estensioni kernel -->
      <directories check_all="yes">/Library/Extensions</directories>
      <directories check_all="yes">/System/Library/Extensions</directories>
      <directories check_all="yes">/Library/Frameworks</directories>
      <!-- Esclusioni ottimizzate per macOS -->
      <ignore>/private/var/log</ignore>
      <ignore>/private/tmp</ignore>
      <ignore>/private/var/tmp</ignore>
      <ignore>/Library/Caches</ignore>
      <ignore>/System/Library/Caches</ignore>
      <ignore>/System/Volumes/Data/.Spotlight-V100</ignore>
      <ignore>/private/var/folders</ignore>
      <ignore>/private/var/db/uuidtext</ignore>
      <ignore>/Users/*/Library/Caches</ignore>
      <ignore>/Users/*/Downloads</ignore>
      <ignore>/Users/*/Library/Logs</ignore>
      <ignore>/Users/*/Library/Mail/V*/MailData</ignore>
      <ignore>/Users/*/Library/Safari</ignore>
      <ignore>/Users/*/Library/Application Support/CrashReporter</ignore>
      <!-- Ignora file temporanei e non critici -->
      <ignore type="sregex">\.DS_Store$</ignore>
      <ignore type="sregex">\.log$</ignore>
      <ignore type="sregex">\.tmp$</ignore>
      <ignore type="sregex">\.bak$</ignore>
      <ignore type="sregex">\.swp$</ignore>
      <ignore type="sregex">\.localized$</ignore>
      <!-- Registri di cambio dimensioni file -->
      <nodiff>/private/etc/krb5.keytab</nodiff>
    </syscheck>
    <!-- Client Buffer - OTTIMIZZAZIONE PERFORMANCE -->
    <client_buffer>
      <disabled>no</disabled>
      <queue_size>5000</queue_size>
      <!-- Per Apple Silicon può essere 7500 -->
      <events_per_second>500</events_per_second>
      <!-- Per Apple Silicon può essere 750 -->
    </client_buffer>
    <!-- Active Response (opzionale ma consigliato) -->
    <active-response>
      <disabled>no</disabled>
      <ca_store>/Library/Ossec/etc/wpk_root.pem</ca_store>
    </active-response>
    <!-- Syscollector - INVENTARIO SISTEMA -->
    <wodle name="syscollector">
      <disabled>no</disabled>
      <interval>12h</interval>
      <scan_on_start>yes</scan_on_start>
      <hardware>yes</hardware>
      <os>yes</os>
      <network>yes</network>
      <packages>yes</packages>
      <ports all="no">yes</ports>
      <processes>yes</processes>
    </wodle>
    <!-- Vulnerability Detector -->
    <vulnerability-detector>
      <enabled>yes</enabled>
      <interval>5m</interval>
      <min_full_scan_interval>6h</min_full_scan_interval>
      <run_on_start>yes</run_on_start>
    </vulnerability-detector>
    <!-- Log rotation -->
    <logging>
      <log_level>info</log_level>
    </logging>
  </agent_config>

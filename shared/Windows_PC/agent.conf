  <agent_config os="Windows">
    <!-- ============================================ -->
    <!-- WAZUH AGENT CONFIGURATION FOR WINDOWS 10/11  -->
    <!-- Version: 4.12.0 - Fixed Values               -->
    <!-- Optimized for: 200+ Windows Workstations     -->
    <!-- ============================================ -->
    <!-- Client Buffer - Fixed with valid values -->
    <client_buffer>
      <disabled>no</disabled>
      <queue_size>100000</queue_size>
      <events_per_second>500</events_per_second>
      <!-- Max value is 1000, using 500 for safety -->
    </client_buffer>
    <!-- Security Configuration Assessment (SCA) -->
    <sca>
      <enabled>yes</enabled>
      <interval>12h</interval>
      <scan_on_start>yes</scan_on_start>
      <skip_nfs>yes</skip_nfs>
    </sca>
    <!-- Agent Upgrade -->
    <agent-upgrade>
      <enabled>yes</enabled>
      <notification_wait_start>60</notification_wait_start>
      <!-- Removed 's' suffix -->
      <notification_wait_factor>2</notification_wait_factor>
      <notification_wait_max>7200</notification_wait_max>
      <!-- In seconds, not '2h' -->
      <ca_verification>
        <enabled>yes</enabled>
        <ca_store>etc/wpk_root.pem</ca_store>
      </ca_verification>
    </agent-upgrade>
    <!-- Rootcheck for Windows -->
    <rootcheck>
      <frequency>43200</frequency>
      <disabled>no</disabled>
      <check_files>yes</check_files>
      <check_trojans>yes</check_trojans>
      <check_dev>no</check_dev>
      <check_sys>yes</check_sys>
      <check_pids>no</check_pids>
      <check_ports>yes</check_ports>
      <check_if>no</check_if>
      <check_winaudit>yes</check_winaudit>
      <check_winapps>yes</check_winapps>
      <check_winmalware>yes</check_winmalware>
      <rootkit_files>shared/win_applications_rcl.txt</rootkit_files>
      <rootkit_trojans>shared/win_malware_rcl.txt</rootkit_trojans>
      <system_audit>shared/win_audit_rcl.txt</system_audit>
    </rootcheck>
    <!-- Vulnerability Detector -->
    <vulnerability-detector>
      <enabled>yes</enabled>
      <interval>5m</interval>
      <min_full_scan_interval>6h</min_full_scan_interval>
      <run_on_start>yes</run_on_start>
    </vulnerability-detector>
    <!-- Syscollector -->
    <wodle name="syscollector">
      <disabled>no</disabled>
      <interval>1h</interval>
      <scan_on_start>yes</scan_on_start>
      <hardware>yes</hardware>
      <os>yes</os>
      <network>yes</network>
      <packages>yes</packages>
      <ports all="no">yes</ports>
      <processes>yes</processes>
      <hotfixes>yes</hotfixes>
    </wodle>
    <!-- ============================================ -->
    <!-- SYSMON EVENT COLLECTION                      -->
    <!-- ============================================ -->
    <!-- Sysmon - All Events -->
    <localfile>
      <location>Microsoft-Windows-Sysmon/Operational</location>
      <log_format>eventchannel</log_format>
    </localfile>
    <!-- ============================================ -->
    <!-- WINDOWS SECURITY EVENTS                      -->
    <!-- ============================================ -->
    <!-- Security Events - Critical Only -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Security</location>
      <query>
            Event[System[(EventID=1102 or EventID=1100 or EventID=4624 or EventID=4625 or 
                         EventID=4648 or EventID=4672 or EventID=4688 or EventID=4697 or 
                         EventID=4698 or EventID=4699 or EventID=4700 or EventID=4701 or 
                         EventID=4702 or EventID=4719 or EventID=4720 or EventID=4722 or 
                         EventID=4723 or EventID=4724 or EventID=4725 or EventID=4726 or 
                         EventID=4732 or EventID=4733 or EventID=4740 or EventID=4756 or 
                         EventID=4757 or EventID=4767 or EventID=4776 or EventID=4794 or
                         EventID=4886 or EventID=4887 or EventID=4888 or EventID=4904 or 
                         EventID=4905 or EventID=5136 or EventID=5137 or EventID=5138 or 
                         EventID=5139 or EventID=5140 or EventID=5141 or EventID=5142)]]
        </query>
    </localfile>
    <!-- System Events -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>System</location>
      <query>
            Event[System[(EventID=7045 or EventID=7040 or EventID=7036 or EventID=104 or 
                         EventID=1074 or EventID=6005 or EventID=6006 or EventID=6008 or 
                         EventID=1001)]]
        </query>
    </localfile>
    <!-- PowerShell - Enhanced Detection -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-PowerShell/Operational</location>
      <query>
            Event[System[(EventID=4103 or EventID=4104 or EventID=4105 or EventID=4106)]]
        </query>
    </localfile>
    <!-- Windows Defender -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-Windows Defender/Operational</location>
      <query>
            Event[System[(EventID=1006 or EventID=1007 or EventID=1008 or EventID=1009 or
                         EventID=1010 or EventID=1011 or EventID=1012 or EventID=1013 or
                         EventID=1015 or EventID=1116 or EventID=1117 or EventID=1118 or
                         EventID=1119 or EventID=5001 or EventID=5004 or EventID=5007 or
                         EventID=5010 or EventID=5012)]]
        </query>
    </localfile>
    <!-- WMI Activity -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-WMI-Activity/Operational</location>
      <query>
            Event[System[(EventID=5857 or EventID=5858 or EventID=5859 or 
                         EventID=5860 or EventID=5861)]]
        </query>
    </localfile>
    <!-- Task Scheduler -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-TaskScheduler/Operational</location>
      <query>
            Event[System[(EventID=106 or EventID=140 or EventID=141 or 
                         EventID=142 or EventID=200 or EventID=201)]]
        </query>
    </localfile>
    <!-- USB Device Monitoring -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-DriverFrameworks-UserMode/Operational</location>
      <query>
            Event[System[(EventID=2003 or EventID=2004 or EventID=2006 or 
                         EventID=2010 or EventID=2100 or EventID=2101)]]
        </query>
    </localfile>
    <!-- Windows Firewall -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-Windows Firewall With Advanced Security/Firewall</location>
      <query>
            Event[System[(EventID=2002 or EventID=2003 or EventID=2004 or 
                         EventID=2005 or EventID=2006 or EventID=2033)]]
        </query>
    </localfile>
    <!-- Application Crashes -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Application</location>
      <query>
            Event[System[(EventID=1000 or EventID=1001 or EventID=1002) and 
                        (Level=1 or Level=2)]]
        </query>
    </localfile>
    <!-- BITS Activity -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-Bits-Client/Operational</location>
      <query>
            Event[System[(EventID=59 or EventID=60 or EventID=61)]]
        </query>
    </localfile>
    <!-- DNS Client Events -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-DNS-Client/Operational</location>
      <query>
            Event[System[(EventID=3008)]]
        </query>
    </localfile>
    <!-- Code Integrity -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-CodeIntegrity/Operational</location>
      <query>
            Event[System[(EventID=3001 or EventID=3002 or EventID=3003 or 
                         EventID=3004 or EventID=3010 or EventID=3023)]]
        </query>
    </localfile>
    <!-- AppLocker -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-AppLocker/EXE and DLL</location>
    </localfile>
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-AppLocker/MSI and Script</location>
    </localfile>
    <!-- Terminal Services -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Microsoft-Windows-TerminalServices-LocalSessionManager/Operational</location>
      <query>
            Event[System[(EventID=21 or EventID=22 or EventID=23 or 
                         EventID=24 or EventID=25 or EventID=39 or EventID=40)]]
        </query>
    </localfile>
    <!-- Microsoft Office -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>OAlerts</location>
    </localfile>
    <!-- Antivirus Events -->
    <localfile>
      <log_format>eventchannel</log_format>
      <location>Application</location>
      <query>
            Event[System[Provider[@Name='ESET' or @Name='ESET Endpoint Antivirus' or 
                                  @Name='ESET PROTECT' or @Name='Symantec Endpoint Protection' or
                                  @Name='McAfee' or @Name='Sophos' or @Name='Kaspersky']] and
                        (Level=1 or Level=2 or Level=3)]
        </query>
    </localfile>
    <!-- ============================================ -->
    <!-- FILE INTEGRITY MONITORING (FIM)              -->
    <!-- ============================================ -->
    <syscheck>
      <frequency>21600</frequency>
      <scan_on_start>no</scan_on_start>
      <process_priority>10</process_priority>
      <max_eps>50</max_eps>
      <file_limit>
        <enabled>yes</enabled>
        <entries>100000</entries>
      </file_limit>
      <!-- Critical Security Directories -->
      <directories check_all="yes" realtime="yes" report_changes="yes">%PROGRAMDATA%\Microsoft\Windows\Start Menu\Programs\Startup</directories>
      <directories check_all="yes" realtime="yes" report_changes="yes">%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup</directories>
      <directories check_all="yes" realtime="yes">%WINDIR%\System32\drivers\etc</directories>
      <directories check_all="yes" realtime="yes" recursion_level="2">%WINDIR%\System32\Tasks</directories>
      <directories check_all="yes" realtime="yes">%WINDIR%\System32</directories>
      <directories check_all="yes" realtime="yes">%WINDIR%\SysWOW64</directories>
      <!-- Program Files -->
      <directories check_all="yes" realtime="yes">C:\Program Files</directories>
      <directories check_all="yes" realtime="yes">C:\Program Files (x86)</directories>
      <!-- User Profiles -->
      <directories check_all="yes" realtime="yes" report_changes="yes">C:\Users\*\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline</directories>
      <directories check_all="yes" realtime="yes" report_changes="yes">C:\Users\*\AppData\Roaming\Microsoft\Office</directories>
      <directories check_all="yes" realtime="yes" report_changes="yes">C:\Users\*\AppData\Local\Microsoft\Office</directories>
      <!-- Downloads and Temp -->
      <directories check_all="yes" realtime="yes" report_changes="yes">C:\Users\*\Downloads</directories>
      <directories check_all="yes" realtime="yes">C:\Users\*\AppData\Local\Temp</directories>
      <directories check_all="yes" realtime="yes">C:\Windows\Temp</directories>
      <!-- Registry Monitoring -->
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx</windows_registry>
      <windows_registry arch="both">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</windows_registry>
      <windows_registry arch="both">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Classes\exefile\shell\open\command</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Classes\htafile\shell\open\command</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Active Setup\Installed Components</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options</windows_registry>
      <windows_registry arch="both">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Print\Monitors</windows_registry>
      <!-- Exclusions -->
      <ignore>C:\Program Files (x86)\ossec-agent</ignore>
      <ignore>C:\Windows\Temp</ignore>
      <ignore>C:\Windows\SoftwareDistribution</ignore>
      <ignore>C:\Windows\WinSxS</ignore>
      <ignore>C:\Windows\Installer</ignore>
      <ignore>C:\Windows\Logs</ignore>
      <ignore>C:\Windows\Prefetch</ignore>
      <ignore>C:\Windows\assembly</ignore>
      <ignore>C:\Windows\System32\wbem\Logs</ignore>
      <ignore>C:\Windows\System32\LogFiles</ignore>
      <ignore>C:\Windows\ServiceProfiles</ignore>
      <ignore>C:\Windows\Debug</ignore>
      <ignore>C:\ProgramData\Microsoft\Windows\WER</ignore>
      <ignore>C:\ProgramData\Microsoft\Windows Defender</ignore>
      <ignore>C:\Program Files\Windows Defender</ignore>
      <ignore>C:\Program Files\WindowsApps</ignore>
      <ignore>C:\Users\*\AppData\Local\Temp</ignore>
      <ignore>C:\Users\*\AppData\Local\Microsoft\Windows\INetCache</ignore>
      <ignore>C:\Users\*\AppData\Local\Microsoft\Windows\WebCache</ignore>
      <ignore>C:\Users\*\AppData\Local\Microsoft\Windows\Explorer</ignore>
      <ignore>C:\Users\*\AppData\Local\Google</ignore>
      <ignore>C:\Users\*\AppData\Local\Microsoft\Edge</ignore>
      <ignore>C:\Users\*\AppData\Local\Mozilla</ignore>
      <ignore>C:\Users\*\AppData\Local\Microsoft\Teams</ignore>
      <ignore>C:\Users\*\AppData\Roaming\Microsoft\Teams</ignore>
      <ignore>C:\Users\*\AppData\Local\Slack</ignore>
      <ignore>C:\Users\*\AppData\Local\Discord</ignore>
      <ignore>C:\Users\*\OneDrive</ignore>
      <ignore>C:\System Volume Information</ignore>
      <ignore>C:\pagefile.sys</ignore>
      <ignore>C:\hiberfil.sys</ignore>
      <ignore>C:\swapfile.sys</ignore>
      <!-- File Type Exclusions -->
      <ignore type="sregex">\.log$|\.tmp$|\.temp$|\.bak$|\.old$|\.cache$</ignore>
      <ignore type="sregex">\.db$|\.sqlite$|\.etl$|\.pf$</ignore>
      <!-- Monitor only hashes for these -->
      <nodiff type="sregex">\.txt$|\.jpg$|\.jpeg$|\.png$|\.gif$|\.pdf$|\.doc$|\.docx$|\.xls$|\.xlsx$</nodiff>
      <alert_new_files>yes</alert_new_files>
    </syscheck>
    <!-- ============================================ -->
    <!-- OSQUERY INTEGRATION                          -->
    <!-- ============================================ -->
    <wodle name="osquery">
      <disabled>yes</disabled>
      <run_daemon>yes</run_daemon>
      <bin_path>C:\Program Files\osquery\osqueryd\osqueryd.exe</bin_path>
      <log_path>C:\Program Files\osquery\log\osqueryd.results.log</log_path>
      <config_path>C:\Program Files\osquery\osquery.conf</config_path>
      <add_labels>yes</add_labels>
    </wodle>
    <!-- ============================================ -->
    <!-- SYSMON CONFIGURATION UPDATE                  -->
    <!-- ============================================ -->
    <wodle name="command">
      <disabled>no</disabled>
      <tag>sysmon-config-update</tag>
      <command>Powershell.exe -ExecutionPolicy Bypass -Command "if (Test-Path 'C:\Program Files (x86)\ossec-agent\shared\sysmonconfig.xml') { if (Test-Path 'C:\Windows\Sysmon64.exe') { C:\Windows\Sysmon64.exe -c 'C:\Program Files (x86)\ossec-agent\shared\sysmonconfig.xml' 2>$null; Write-Host 'Sysmon config updated' } }"</command>
      <interval>1d</interval>
      <run_on_start>yes</run_on_start>
      <timeout>60</timeout>
    </wodle>
    <!-- ============================================ -->
    <!-- COMMAND MONITORING                           -->
    <!-- ============================================ -->
    <!-- Check for suspicious scheduled tasks -->
    <wodle name="command">
      <disabled>no</disabled>
      <tag>scheduled-tasks</tag>
      <command>Powershell.exe -ExecutionPolicy Bypass -Command "Get-ScheduledTask | Where-Object {$_.State -eq 'Ready'} | Select-Object -First 20 TaskName, TaskPath | ConvertTo-Json -Compress"</command>
      <interval>1h</interval>
      <run_on_start>yes</run_on_start>
      <timeout>60</timeout>
    </wodle>
    <!-- Check for network connections -->
    <wodle name="command">
      <disabled>no</disabled>
      <tag>network-connections</tag>
      <command>netstat -an | find "ESTABLISHED" | find /c /v ""</command>
      <interval>5m</interval>
      <run_on_start>yes</run_on_start>
      <timeout>30</timeout>
    </wodle>
    <!-- ============================================ -->
    <!-- ACTIVE RESPONSE                              -->
    <!-- ============================================ -->
    <active-response>
      <disabled>no</disabled>
      <ca_store>C:\Program Files (x86)\ossec-agent\wpk_root.pem</ca_store>
      <repeated_offenders>60,120,240</repeated_offenders>
    </active-response>
    <!-- ============================================ -->
    <!-- LABELS                                       -->
    <!-- ============================================ -->
    <labels>
      <label key="environment">production</label>
      <label key="os">windows</label>
      <label key="role">workstation</label>
      <label key="sysmon">enabled</label>
    </labels>
  </agent_config>

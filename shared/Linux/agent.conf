  <agent_config>
    <!-- NOTA: Questo file NON deve avere <?xml version...> quando usato in Wazuh Manager -->
    <!-- La dichiarazione XML è già gestita dal sistema -->
    <!-- Client Buffer - Performance Optimization -->
    <client_buffer>
      <disabled>no</disabled>
      <queue_size>100000</queue_size>
      <events_per_second>500</events_per_second>
    </client_buffer>
    <!-- Security Configuration Assessment (SCA) -->
    <sca>
      <enabled>yes</enabled>
      <interval>12h</interval>
      <scan_on_start>yes</scan_on_start>
      <skip_nfs>yes</skip_nfs>
      <policies>
        <policy>ruleset/sca/cis_ubuntu22-04.yml</policy>
        <policy>ruleset/sca/cis_ubuntu24-04.yml</policy>
      </policies>
    </sca>
    <!-- Agent Upgrade -->
    <agent-upgrade>
      <enabled>yes</enabled>
      <notification_wait_start>60s</notification_wait_start>
      <notification_wait_factor>2</notification_wait_factor>
      <notification_wait_max>2h</notification_wait_max>
      <ca_verification>
        <enabled>yes</enabled>
        <ca_store>etc/wpk_root.pem</ca_store>
      </ca_verification>
    </agent-upgrade>
    <!-- File Integrity Monitoring Optimized -->
    <syscheck>
      <frequency>3600</frequency>
      <scan_on_start>no</scan_on_start>
      <max_files_per_second>100</max_files_per_second>
      <file_limit>
        <enabled>yes</enabled>
        <entries>500000</entries>
      </file_limit>
      <!-- System directories -->
      <directories check_all="yes">/etc,/bin,/usr/bin,/usr/sbin,/boot</directories>
      <!-- Real-time monitoring for critical paths -->
      <directories check_all="yes" realtime="yes">/etc</directories>
      <directories check_all="yes" realtime="yes">/var/www</directories>
      <directories check_all="yes" realtime="yes">/root</directories>
      <!-- Report changes DISABLED for now -->
      <!-- Light scan directories REMOVED -->
      <!-- Exclusions -->
      <ignore>/etc/mtab</ignore>
      <ignore>/etc/hosts.deny</ignore>
      <ignore>/var/cache</ignore>
      <ignore>/var/lib/docker</ignore>
      <ignore>/var/lib/containerd</ignore>
      <ignore>/proc</ignore>
      <ignore>/sys</ignore>
      <ignore>/dev</ignore>
      <ignore>/run</ignore>
      <ignore>/var/run</ignore>
      <ignore>/etc/csf/csf.tempban</ignore>
      <ignore>/etc/csf/csf.tempallow</ignore>
      <ignore>/opt/veeam/transport</ignore>
      <ignore>/opt/veeam/backup</ignore>
      <ignore>/var/log/veeam</ignore>
      <ignore>/opt/forticlientems/data/signatures</ignore>
      <ignore>/opt/forticlientems/updates</ignore>
      <ignore>/opt/EcoStruxureITGateway</ignore>
      <ignore type="sregex">^/root/tmp/veeamagent_</ignore>
      <ignore>/opt/zammad/tmp/cache_file_store_production</ignore>
      <ignore>/var/www/html/scratch/logs</ignore>
      <ignore>/tmp/yara/rules</ignore>
      <ignore>/var/ossec/tmp</ignore>
      <ignore>/var/ossec/queue</ignore>
      <ignore>/var/ossec/logs</ignore>
      <ignore>/var/ossec/stats</ignore>
      <!-- Pattern exclusions -->
      <ignore type="sregex">\.log$|\.swp$|\.tmp$|\.cache$|\.pid$|\.lock$</ignore>
      <ignore type="sregex">\.vbm$|\.vib$|\.vrb$</ignore>
      <ignore type="sregex">VeeamAgentTmp_</ignore>
      <alert_new_files>yes</alert_new_files>
      <auto_ignore>no</auto_ignore>
    </syscheck>
    <!-- Rootcheck optimized -->
    <rootcheck>
      <frequency>7200</frequency>
      <disabled>no</disabled>
      <check_files>yes</check_files>
      <check_trojans>yes</check_trojans>
      <check_dev>yes</check_dev>
      <check_sys>yes</check_sys>
      <check_pids>yes</check_pids>
      <check_ports>yes</check_ports>
      <check_if>yes</check_if>
      <skip_nfs>yes</skip_nfs>
    </rootcheck>
    <!-- System logs -->
    <localfile>
      <log_format>syslog</log_format>
      <location>/var/log/auth.log</location>
    </localfile>
    <localfile>
      <log_format>syslog</log_format>
      <location>/var/log/syslog</location>
    </localfile>
    <!-- kern.log with filter -->
    <localfile>
      <log_format>syslog</log_format>
      <location>/var/log/kern.log</location>
      <ignore>^kernel: \[ *[0-9]+\.[0-9]+\] audit:</ignore>
    </localfile>
    <!-- Active responses log -->
    <localfile>
      <log_format>syslog</log_format>
      <location>/var/ossec/logs/active-responses.log</location>
    </localfile>
    <!-- CSF/LFD -->
    <localfile>
      <log_format>syslog</log_format>
      <location>/var/log/lfd.log</location>
    </localfile>
    <!-- Apache logs -->
    <localfile>
      <log_format>apache</log_format>
      <location>/var/log/apache2/error.log</location>
    </localfile>
    <localfile>
      <log_format>apache</log_format>
      <location>/var/log/apache2/access.log</location>
    </localfile>
    <!-- Suricata IDS -->
    <localfile>
      <log_format>json</log_format>
      <location>/var/log/suricata/eve.json</location>
      <label key="ids">suricata</label>
    </localfile>
    <!-- Audit logs -->
    <localfile>
      <log_format>audit</log_format>
      <location>/var/log/audit/audit.log</location>
    </localfile>
    <!-- CSF Monitoring Commands -->
    <localfile>
      <log_format>full_command</log_format>
      <command>csf -g | tail -20</command>
      <alias>CSF recent blocks</alias>
      <frequency>600</frequency>
    </localfile>
    <localfile>
      <log_format>full_command</log_format>
      <command>csf -t | wc -l</command>
      <alias>CSF temp IP count</alias>
      <frequency>600</frequency>
    </localfile>
    <localfile>
      <log_format>full_command</log_format>
      <command>grep "DENY" /etc/csf/csf.deny | wc -l</command>
      <alias>CSF permanent blocks count</alias>
      <frequency>1800</frequency>
    </localfile>
    <!-- Network monitoring -->
    <localfile>
      <log_format>full_command</log_format>
      <command>ss -tulpn</command>
      <frequency>600</frequency>
    </localfile>
    <!-- Process monitoring -->
    <localfile>
      <log_format>full_command</log_format>
      <command>ps aux | grep -E '(nc |ncat |/bin/sh|/bin/bash)' | grep -v grep</command>
      <frequency>300</frequency>
    </localfile>
    <!-- Resource monitoring -->
    <localfile>
      <log_format>full_command</log_format>
      <command>free -m | awk 'NR==2{printf "Memory: %.2f%%\n", $3*100/$2 }'</command>
      <alias>memory_usage</alias>
      <frequency>600</frequency>
    </localfile>
    <localfile>
      <log_format>full_command</log_format>
      <command>df -h | grep -vE '^Filesystem|tmpfs|cdrom|udev' | awk '{ print $5 " " $6 }' | grep -E '[8-9][0-9]%|100%'</command>
      <alias>disk_usage_critical</alias>
      <frequency>1800</frequency>
    </localfile>
    <!-- Yara Active Response -->
    <active-response>
      <disabled>no</disabled>
      <command>yara_linux</command>
      <location>local</location>
      <rules_id>550,554</rules_id>
    </active-response>
    <!-- Host Deny Active Response -->
    <active-response>
      <command>host-deny</command>
      <location>local</location>
      <rules_id>5712,5710,5706,5503,5505,5601,5720,100002</rules_id>
      <timeout>3600</timeout>
    </active-response>
    <!-- Vulnerability detector -->
    <vulnerability-detector>
      <enabled>yes</enabled>
      <interval>5m</interval>
      <min_full_scan_interval>6h</min_full_scan_interval>
      <run_on_start>yes</run_on_start>
    </vulnerability-detector>
    <!-- Syscollector - TEMPORARILY DISABLED -->
    <wodle name="syscollector">
      <disabled>no</disabled>
      <interval>6h</interval>
      <scan_on_start>no</scan_on_start>
      <hardware>yes</hardware>
      <os>yes</os>
      <network>yes</network>
      <packages>yes</packages>
      <ports all="no">yes</ports>
      <processes>yes</processes>
    </wodle>
    <!-- Docker listener if Docker is present -->
    <wodle name="docker-listener">
      <disabled>no</disabled>
      <interval>5m</interval>
      <attempts>3</attempts>
      <run_on_start>yes</run_on_start>
    </wodle>
  </agent_config>
